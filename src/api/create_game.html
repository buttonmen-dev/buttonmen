<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>

    <meta charset="utf-8" />
    <title>Start new game</title>
    <link rel="stylesheet" href="jquery-ui.css" />
    <link rel="stylesheet" href="gui.css" />

</head>

<body>
    <div class="title2">Create a new game</div>

    <br />

    <div>
        <table id="button_choice_table">
            <tr>
                <td>
                    You:
                </td>
                <td>
                    <span id="your_player_name"></span>
                </td>
            </tr>
            <tr>
                <td>
                    Opponent:
                </td>
                <td>
                    <input type="text" id="opp_player_name" name="opp_player_name"/>
                </td>
            </tr>
            <tr>
                <td>
                    Your button:
                </td>
                <td>
                    <select id="select_you">
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    Opponent's button:
                </td>
                <td>
                    <select id="select_opp">
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    Number of rounds:
                </td>
                <td>
                    <select id="n_rounds">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected="selected">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </td>
            </tr>
        </table>
    </div>

    <br />

    <div ><button id="submit">Start game!</button></div>
    <br />
    <div><span id="submit_status"></span></div>

    <br />
    <div><span id="debug_message"></span></div>

    <!--
    james: eventually, we will want to use the hosted version of the JQuery libraries
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    -->
    <script src="jquery-1.9.0.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script>
        $(document).ready(function() {
            // global variables
            var message = '';

            // functions
            function loadPlayerName() {
                $.post('responder.php',
                       {type: 'loadPlayerName'},
                       function(rs){
                           $('#your_player_name').text(rs.data);
                           message = rs.message;
                       });
            }

            function loadButtonNames() {
                $.post('responder.php',
                       {type: 'loadButtonNames'},
                       function(rs){
                           // add buttons to selects
                           for (var buttonIdx = 0;
                                buttonIdx < rs.buttonNameArray.length;
                                buttonIdx++) {
                               var buttonName = rs.buttonNameArray[buttonIdx];
                               var recipe = rs.recipeArray[buttonIdx];
                               $('#select_you').append(
                                   $('<option></option>').
                                       text(buttonName + ' : ' + recipe).
                                       val(buttonName));
                               $('#select_opp').append(
                                   $('<option></option>').
                                       text(buttonName + ' : ' + recipe).
                                       val(buttonName));
                           }
                           message = rs.message;
                       });
            }

            $('#opp_player_name').autocomplete({
                source: function(request, response) {
                    $.post('responder.php',
                           {type: 'loadPlayerNamesLike',
                            input: request.term},
                           function(rs) {
                               response(rs.nameArray);
                           },
                           'json');
                },
                delay: 500
//                ,
//                messages: {
//                    noResults: '',
//                    results: function() {}
//                }
                });

            $('#submit').click(function() {
                var playerNameArray = [];
                playerNameArray[0] = $('#your_player_name').text();
                playerNameArray[1] = $('#opp_player_name').val();

                // check that the opponent's name is filled in
                if (!playerNameArray[1]) {
                    return false;
                }

                var areNamesValid = false;
                // check that the players' names are valid
                var nameCheck = $.post('responder.php',
                                       {type: 'checkPlayerNames',
                                        playerNameArray: playerNameArray},
                                       function(rs){
                                           areNamesValid = rs.data;
                                           message = rs.message;
                                       });

                nameCheck.done(function() {
                    $('#submit_status').text(message);
                    if (!areNamesValid) {
                        return false;
                    }
                });

                // get both button selections
                var buttonNameArray = [];
                buttonNameArray[0] = $('#select_you').val();
                buttonNameArray[1] = $('#select_opp').val();

                // get number of rounds
                var maxWins = $('#n_rounds').val();

                // post both button selections and create game
                $.post('responder.php',
                       {type: 'chooseButtons',
                        playerNameArray: playerNameArray,
                        buttonNameArray: buttonNameArray,
                        maxWins: maxWins},
                       function(rs){
                           // give feedback about the status of the submit
                           $('#debug_message').html(rs);
                       });
            });

            // code to run when page is ready
            loadPlayerName();
            loadButtonNames();
        });

    </script>
</body>
</html>