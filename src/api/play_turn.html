<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8" />
    <title>JSON Testing</title>
    <link rel="stylesheet" href="gui.css" />
</head>

<body>
    <div>Game #<span id="game_id">?</span></div>
    <div>Round #<span id="round_number">?</span></div>
    <br />
    <!-- attacker dice -->
    <div>Player #<span id="attacker_id">?</span></div>
    <div>Button: <span id="attacker_button">?</span></div>
    <div>W/L/T: <span id="attacker_game_score">?</span></div>
    <div>Score: <span id="attacker_round_score">?</span></div>
    <div id="div_attack"></div>
    <br />
    <!-- defender dice -->
    <div id="div_defend"></div>
    <div>Score: <span id="defender_round_score">?</span></div>
    <div>W/L/T: <span id="defender_game_score">?</span></div>
    <div>Button: <span id="defender_button">?</span></div>
    <div>Player #<span id="defender_id">?</span></div>
    <br />
    <div ><button id="submit">Submit</button></div>
    <br />
    <div><span id="submit_status"></span></div>
    <br />
    <div>Last action time: <span id="timestamp">?</span></div>

    <!--
    james: eventually, we will want to use the hosted version of the JQuery library
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    -->
    <script src="jquery-1.9.0.min.js"></script>
    <script>

    $(document).ready(function() {
        // global variables
        var attackerIdx;
        var defenderIdx;
        var dieAttackValues;
        var dieDefendValues;
        var dieAttackSides;
        var dieDefendSides;

        var dieSelectStatus = {};

        // functions
        function addDie(id, rolledNumber, nSides, parent) {
            if (document.createElement){
                $('#'+parent).append(
                    $('<div id="' + id + '" class="die_img unselected"' +
                      'style="background-image: url(images/Circle.png)">' +
                          '<span id="' + id + '_span" class="die_overlay">' +
                              rolledNumber + ' d' + nSides +
                          '</span>' +
                      '</div>'));
                $('#'+id).click(borderToggle);

                dieSelectStatus[id] = false;
            }
        }

        function borderToggle() {
            $(this).toggleClass('selected unselected');
        }

        function displayDice() {
            var dieAttackIdx;
            var dieDefendIdx;

            for (dieAttackIdx = 0;
                 dieAttackIdx < dieAttackValues.length;
                 dieAttackIdx++) {
                addDie('playerIdx_' + attackerIdx +
                       '_dieIdx_' + dieAttackIdx,
                       dieAttackValues[dieAttackIdx],
                       dieAttackSides[dieAttackIdx],
                       'div_attack');
            }

            for (dieDefendIdx = 0;
                 dieDefendIdx < dieDefendValues.length;
                 dieDefendIdx++) {
                addDie('playerIdx_' + defenderIdx +
                       '_dieIdx_' + dieDefendIdx,
                       dieDefendValues[dieDefendIdx],
                       dieDefendSides[dieDefendIdx],
                       'div_defend');
            }
        }

        function loadGameInfo() {
            $.post('responder.php',
                   {type: 'loadGameData'},
                   function(rs) {
                       if (rs.status == 'ok') {
                           // need to explicitly convert the activePlayerIdx to
                           // an integer, so that I can perform integer addition
                           attackerIdx = parseInt(rs.gameData.data.activePlayerIdx, 10);
                           defenderIdx = (attackerIdx + 1)%2;

                           dieAttackValues = rs.gameData.data.valueArrayArray[attackerIdx];
                           dieDefendValues = rs.gameData.data.valueArrayArray[defenderIdx];
                           dieAttackSides  = rs.gameData.data.sidesArrayArray[attackerIdx];
                           dieDefendSides  = rs.gameData.data.sidesArrayArray[defenderIdx];
                           $('#attacker_id').text(rs.gameData.data.playerIdArray[attackerIdx]);
                           $('#defender_id').text(rs.gameData.data.playerIdArray[defenderIdx]);

                           var attackerGameScoreArray = rs.gameData.data.gameScoreArrayArray[attackerIdx];
                           var attackerGameScore = attackerGameScoreArray.W + '/' +
                                                   attackerGameScoreArray.L + '/' +
                                                   attackerGameScoreArray.D;
                           $('#attacker_game_score').text(attackerGameScore);
                           var defenderGameScoreArray = rs.gameData.data.gameScoreArrayArray[defenderIdx];
                           var defenderGameScore = defenderGameScoreArray.W + '/' +
                                                   defenderGameScoreArray.L + '/' +
                                                   defenderGameScoreArray.D;
                           $('#defender_game_score').text(defenderGameScore);

                           $('#attacker_button').text(rs.gameData.data.buttonNameArray[attackerIdx]);
                           $('#defender_button').text(rs.gameData.data.buttonNameArray[defenderIdx]);
                           $('#attacker_round_score').text(rs.gameData.data.roundScoreArray[attackerIdx]);
                           $('#defender_round_score').text(rs.gameData.data.roundScoreArray[defenderIdx]);
                           $('#game_id').text(rs.gameData.data.gameId);
                           $('#round_number').text(rs.gameData.data.roundNumber);
                           $('#timestamp').text(rs.timestamp);



                           displayDice();
                       } else {
                           // We got some JSON we didn't expect
                           // (the network fetch succeeded, but the engine had an error)
                           $('#result').html('JSON fetch failed\n'+
                                             JSON.stringify(rs.gameData.data));                       }
                   });
        }

        $('#submit').click(function() {
            for (var statusKey in dieSelectStatus) {
                dieSelectStatus[statusKey] = false;
            }
            $('div.selected').each(function(index, element) {
                dieSelectStatus[$(element).attr('id')] = true;
            });
            $.post('responder.php',
                   {
                       type: 'submitTurn',
                       attackerIdx: attackerIdx,
                       defenderIdx: defenderIdx,
                       dieSelectStatus: dieSelectStatus,
                       timestamp: $('#timestamp').text(),
                       roundNumber: $('#round_number').text()
                   },
                   function(data){
                       $('#submit_status').html(data.status);
                   });
        });

        // code to run when page is ready
        loadGameInfo();
    });

    </script>
</body>
</html>