<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Determine initiative</title>
        <link rel="stylesheet" href="gui.css" />
    </head>
    <body>
        <div>Game #<span id="game_id">?</span></div>
        <div>Round #<span id="round_number">?</span></div>
        <br />

        <!-- current player dice -->
        <div>Player #<span id="current_player_id">?</span></div>
        <div>Button: <span id="current_button">?</span></div>
        <div id="div_current_player"></div>
        <br />
        <!-- opponent dice -->
        <div id="div_opponent"></div>
        <div>Button: <span id="opponent_button">?</span></div>
        <div>Player #<span id="opponent_player_id">?</span></div>
        <br />
        <!-- initiative message -->
        <div id="div_initiative"></div>

        <!--
        james: eventually, we will want to use the hosted version of the JQuery library
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        -->
        <script src="jquery-1.9.0.min.js"></script>
        <script>

        $(document).ready(function() {
            // global variables
            var currentPlayerIdx;
            var opponentPlayerIdx;
            var currentPlayerSidesArray;
            var opponentPlayerSidesArray;
            var currentPlayerDieValueArray;
            var opponentPlayerDieValueArray;
            var nCurrentPlayerDice;
            var nOpponentPlayerDice;
            var playerWithInitiativeId;

            // functions
            function addDie(id, rolledNumber, nSides, parent) {
                if (document.createElement){
                    $('#'+parent).append(
                        $('<div id="' + id + '" class="die_img unselected"' +
                          'style="background-image: url(images/Circle.png)">' +
                              '<span id="' + id + '_span" class="die_overlay">' +
                                  rolledNumber + ' d' + nSides +
                              '</span>' +
                          '</div>'));
                }
            }

            function displayDice() {
                var dieCurrentIdx;
                var dieOpponentIdx;

                for (dieCurrentIdx = 0;
                     dieCurrentIdx < nCurrentPlayerDice;
                     dieCurrentIdx++) {
                    addDie('playerIdx_' + currentPlayerIdx +
                           '_dieIdx_' + dieCurrentIdx,
                           currentPlayerDieValueArray[dieCurrentIdx],
                           currentPlayerSidesArray[dieCurrentIdx],
                           'div_current_player');
                }

                for (dieOpponentIdx = 0;
                     dieOpponentIdx < nOpponentPlayerDice;
                     dieOpponentIdx++) {
                    addDie('playerIdx_' + opponentPlayerIdx +
                           '_dieIdx_' + dieOpponentIdx,
                           opponentPlayerDieValueArray[dieOpponentIdx],
                           opponentPlayerSidesArray[dieOpponentIdx],
                           'div_opponent');
                }
            }

            function displayInitiativeDetails() {
                $('#div_initiative').text('Player #' + playerWithInitiativeId +
                                          ' has won initiative.');
            }

            function loadGameInfo() {
                jQuery.ajax({                                   // Do a jQuery AJAX fetch
                    url: 'load_test_game_determining_initiative.php',
                    success: function(rs) {
                        if (rs.status == 'ok') {
                            opponentPlayerIdx = (currentPlayerIdx + 1)%2;
                            nCurrentPlayerDice = rs.data.nDieArray[currentPlayerIdx];
                            nOpponentPlayerDice = rs.data.nDieArray[opponentPlayerIdx];
                            currentPlayerSidesArray = rs.data.sidesArrayArray[currentPlayerIdx];
                            opponentPlayerSidesArray = rs.data.sidesArrayArray[opponentPlayerIdx];
                            currentPlayerDieValueArray = rs.data.valueArrayArray[currentPlayerIdx];
                            opponentPlayerDieValueArray = rs.data.valueArrayArray[opponentPlayerIdx];
//                            swingRequestArray = rs.data.swingRequestArrayArray[currentPlayerIdx];
                            playerWithInitiativeId = rs.data.playerIdArray[rs.data.playerWithInitiativeIdx];

                            $('#game_id').text(rs.data.gameId);
                            $('#round_number').text(rs.data.roundNumber);
                            $('#current_button').text(rs.data.buttonNameArray[currentPlayerIdx]);
                            $('#opponent_button').text(rs.data.buttonNameArray[opponentPlayerIdx]);
                            $('#current_player_id').text(rs.data.playerIdArray[currentPlayerIdx]);
                            $('#opponent_player_id').text(rs.data.playerIdArray[opponentPlayerIdx]);

                            displayDice();
                            displayInitiativeDetails();
                        } else {
                            $('#game_id').html('JSON fetch failed\n'+
                                               JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                        }
                    }
                });
            }

            // code to initialise game variables
            currentPlayerIdx = 1;

            // code to run when page is ready
            loadGameInfo();

        });


        </script>
    </body>
</html>
