<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>

<meta charset="utf-8" />
<title>JSON Testing</title>
<link rel="stylesheet" href="gui.css" />

</head>

<body>
<div>Game #<span id="game_id">?</span></div>
<div>Round #<span id="round_number">?</span></div>
<br />
<!-- attacker dice -->
<div>Player #<span id="attacker_id">?</span></div>
<div>Button: <span id="attacker_button">?</span></div>
<div>W/L/T: <span id="attacker_game_score">?</span></div>
<div>Score: <span id="attacker_round_score">?</span></div>
<div id="div_attack"></div>
<br />
<!-- defender dice -->
<div id="div_defend"></div>
<div>Score: <span id="defender_round_score">?</span></div>
<div>W/L/T: <span id="defender_game_score">?</span></div>
<div>Button: <span id="defender_button">?</span></div>
<div>Player #<span id="defender_id">?</span></div>
<br />
<div ><button id="submit">Submit</button></div>
<br />
<div><span id="submit_status"></span></div>

<!--
james: eventually, we will want to use the hosted version of the JQuery library
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
-->
<script src="jquery-1.9.0.min.js"></script>
<script>

$(document).ready(function() {
    // global variables
    var attackerIdx;
    var defenderIdx;
    var dieAttackValues;
    var dieDefendValues;
    var dieAttackSides;
    var dieDefendSides;

    var dieSelectStatus = new Object;

    // functions
    function addDie(id, rolled_number, nSides, parent) {
        if (document.createElement){
            $('#'+parent).append(
                $('<div id="' + id + '" class="die_img unselected"' +
                  'style="background-image: url(images/Circle.png)">' +
                      '<span id="' + id + '_span" class="die_overlay">' +
                          rolled_number + ' d' + nSides +
                      '</span>' +
                  '</div>'));
            $('#'+id).click(borderToggle);

            dieSelectStatus[id] = false;
        }
    }

    function borderToggle() {
        $(this).toggleClass("selected unselected");
    }

    function displayDice() {
        var dieAttackIdx;
        var dieDefendIdx;

        for (dieAttackIdx = 0;
             dieAttackIdx < dieAttackValues.length;
             dieAttackIdx++) {
            addDie('playerIdx_' + attackerIdx +
                   '_dieIdx_' + dieAttackIdx,
                   dieAttackValues[dieAttackIdx],
                   dieAttackSides[dieAttackIdx],
                   "div_attack");
        }

        for (dieDefendIdx = 0;
             dieDefendIdx < dieDefendValues.length;
             dieDefendIdx++) {
            addDie('playerIdx_' + defenderIdx +
                   '_dieIdx_' + dieDefendIdx,
                   dieDefendValues[dieDefendIdx],
                   dieDefendSides[dieDefendIdx],
                   "div_defend");
        }
    }

    function loadGameInfo() {
        jQuery.ajax({                                   // Do a jQuery AJAX fetch
            url: 'json_test_initial_load_data.php',
            success: function(rs, status, xhr) {
                if (rs.status == 'ok') {
                    attackerIdx = rs.data.activePlayerIdx;
                    defenderIdx = (rs.data.activePlayerIdx + 1)%2;
                    dieAttackValues = rs.data.valueArrayArray[attackerIdx];
                    dieDefendValues = rs.data.valueArrayArray[defenderIdx];
                    dieAttackSides  = rs.data.sidesArrayArray[attackerIdx];
                    dieDefendSides  = rs.data.sidesArrayArray[defenderIdx];
                    $('#attacker_id').text(rs.data.playerIdArray[attackerIdx]);
                    $('#defender_id').text(rs.data.playerIdArray[defenderIdx]);

                    var attacker_game_score_array = rs.data.gameScoreArrayArray[attackerIdx];
                    var attacker_game_score = attacker_game_score_array['W'] + '/' +
                                              attacker_game_score_array['L'] + '/' +
                                              attacker_game_score_array['T'];
                    $('#attacker_game_score').text(attacker_game_score);
                    var defender_game_score_array = rs.data.gameScoreArrayArray[defenderIdx];
                    var defender_game_score = defender_game_score_array['W'] + '/' +
                                              defender_game_score_array['L'] + '/' +
                                              defender_game_score_array['T'];
                    $('#defender_game_score').text(defender_game_score);

                    $('#attacker_button').text(rs.data.buttonNameArray[attackerIdx]);
                    $('#defender_button').text(rs.data.buttonNameArray[defenderIdx]);
                    $('#attacker_round_score').text(rs.data.roundScoreArray[attackerIdx]);
                    $('#defender_round_score').text(rs.data.roundScoreArray[defenderIdx]);
                    $('#game_id').text(rs.data.gameId);
                    $('#round_number').text(rs.data.roundNumber);
                    displayDice();
                } else {
                    $('#result').html("JSON fetch failed\n"+
                                      JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                }
            }
        });
    }

    // on-click behaviour
    $('#fetch').click(function() {                      // When the button is clicked...
        $('#result').html('Fetching...');               // Show that we're doing a network fetch
        fetchGameInfo();
    });

    $('#submit').click(function() {
        for (var statusKey in dieSelectStatus) {
            dieSelectStatus[statusKey] = false;
        }
        $("div.selected").each(function(index, element) {
            dieSelectStatus[$(element).attr('id')] = true;
        })
        $.post('test_submit.php',
               {
                   type: 'loadButtonNames',
                   attackerIdx: attackerIdx,
                   defenderIdx: defenderIdx,
                   dieSelectStatus: JSON.stringify(dieSelectStatus)
               },
               function(data){
                   $('#submit_status').html(data);
               });
    });

    // code to run when page is ready
    loadGameInfo();
});

</script>

</body>
</html>