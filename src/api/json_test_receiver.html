<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>

<meta charset="utf-8" />
<title>JSON Testing</title>
<link rel="stylesheet" href="api.css" />

</head>

<body>
<div>Game #<span id="game_id">?</span></div>
<br />
<!-- attacker dice -->
<div>Player #<span id="attacker_id">?</span></div>
<div>Button: <span id="attacker_button">?</span></div>
<div id="div_attack"></div>
<br />
<!-- defender dice -->
<div id="div_defend"></div>
<div>Button: <span id="defender_button">??</span></div>
<div>Player #<span id="defender_id">??</span></div>
<br />
<div ><button id="submit">Submit</button></div>
<br />
<div><span id="submit_status"></span></div>

<!--
james: eventually, we will want to use the hosted version of the JQuery library
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
-->
<script src="jquery-1.9.0.min.js"></script>
<script>

$(document).ready(function() {
    // global variables
    var attackerIdx;
    var defenderIdx;
    var dieAttackValues;
    var dieDefendValues;
    var dieAttackSides;
    var dieDefendSides;

    var $res = $('#result');

    // functions
    function addDie(id, rolled_number, nSides, parent) {
        if (document.createElement){
            var die_div=document.createElement("div");
            die_div.id=id;
            $('#'+parent).append(die_div);
            $('#'+id).addClass("die_img unselected");
            // next line could theoretically be put into api.css
            // it is here to remind me of the syntax to alter the css directly
            $('#'+id).css("background-image", "url('images/Circle.png')");

            var die_text_span=document.createElement("span");
            die_text_span.id=id+'_span';
            $('#'+id).append(die_text_span);
            $('#'+id+'_span').addClass("die_overlay");
            $('#'+id+'_span').text(rolled_number + ' d' + nSides);

            $('#'+id).click(borderToggle);
        }
    }

    function borderToggle() {
        $(this).toggleClass("selected unselected");
    }

    function displayDice() {
        var dieAttackIdx;
        var dieDefendIdx;

        for (dieAttackIdx = 0;
             dieAttackIdx < dieAttackValues.length;
             dieAttackIdx++) {
            addDie('playerIdx_' + attackerIdx +
                   '_dieIdx_' + dieAttackIdx,
                   dieAttackValues[dieAttackIdx],
                   dieAttackSides[dieAttackIdx],
                   "div_attack");
        }

        for (dieDefendIdx = 0;
             dieDefendIdx < dieDefendValues.length;
             dieDefendIdx++) {
            addDie('playerIdx_' + defenderIdx +
                   '_dieIdx_' + dieDefendIdx,
                   dieDefendValues[dieDefendIdx],
                   dieDefendSides[dieDefendIdx],
                   "div_defend");
        }
    }

    function loadGameInfo() {
        jQuery.ajax({                                   // Do a jQuery AJAX fetch
            url: 'json_test_initial_load_data.php',
            success: function(rs, status, xhr) {
                var $rs = $('#result');
                if (rs.status == 'ok') {
                    attackerIdx = rs.data.activePlayerIdx;
                    defenderIdx = (rs.data.activePlayerIdx + 1)%2;
                    dieAttackValues = rs.data.valueArrayArray[attackerIdx];
                    dieDefendValues = rs.data.valueArrayArray[defenderIdx];
                    dieAttackSides  = rs.data.sidesArrayArray[attackerIdx];
                    dieDefendSides  = rs.data.sidesArrayArray[defenderIdx];
                    $('#attacker_id').html(rs.data.playerIdArray[attackerIdx]);
                    $('#defender_id').html(rs.data.playerIdArray[defenderIdx]);
                    $('#attacker_button').html(rs.data.buttonNameArray[attackerIdx]);
                    $('#defender_button').html(rs.data.buttonNameArray[defenderIdx]);
                    $('#game_id').html(rs.data.gameId);
                    displayDice();
                } else {
                    $rs.html("JSON fetch failed\n"+
                             JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                }
            }
        });
    }

    // on-click behaviour
    $('#fetch').click(function() {                      // When the button is clicked...
        $('#result').html('Fetching...');               // Show that we're doing a network fetch
        fetchGameInfo();
    });

    $('#submit').click(function() {
        var dieText = '';
        $res.html('test1');
        $("div.selected").each(function(index, element) {
            dieText = dieText + $(element).attr('id') + ' ';
        })
        $.post('test_submit.php',
                   {
                       attackerIdx: attackerIdx,
                       defenderIdx: defenderIdx,
                       selectedDice: dieText
                   },
                   function(data, status){
                       $('#submit_status').html(data);
                   });
    });

    // code to run when page is ready
    loadGameInfo();
});

</script>

</body>
</html>