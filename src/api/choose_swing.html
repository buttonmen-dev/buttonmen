<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8" />
    <title>Choose swing values</title>
    <link rel="stylesheet" href="gui.css" />
</head>

<body>
    <div>Game #<span id="game_id">?</span></div>
    <div>Round #<span id="round_number">?</span></div>
    <br />

    <table id="die_description_table">
        <tr>
            <th id="header_current_player"></th>
            <th id="header_opponent"></th>
        </tr>
        <tr>
            <td id="div_current_player"></td>
            <td id="div_opponent"></td>
        </tr>
    </table>

    <br />

    <div class="title2">
        Set your swing values
    </div>

    <div>
    <form action="responder.php" method="post">
        <table id="swing_table">
        </table>
        <br />
        <div><span id="submit_status"></span></div>
    </form>
    </div>

    <br />
    <div ><button id="submit">Submit</button></div>

    <br />
    <div>Last action time: <span id="timestamp">?</span></div>

    <!--
    james: eventually, we will want to use the hosted version of the JQuery library
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    -->
    <script src="jquery-1.9.0.min.js"></script>
    <script>
    $(document).ready(function() {
        function displayDieDetails() {
            $.each(currentPlayerDieRecipeArray, function(index, value) {
                $('#div_current_player').append('<p>' + value + '</p>');
            });

            $.each(opponentPlayerDieRecipeArray, function(index, value) {
                $('#div_opponent').append('<p>' + value + '</p>');
            });
        }

        function displaySwingDetails() {
            if (document.createElement){
                $.each(swingRequestArray, function(index, value) {
                    $('#swing_table').append(
                        $('<tr>' +
                              '<td>' + value + ' :</td>' +
                              '<td><input type="text" class="text" ' +
                                   'id="swing_' + index +
                                   '" ' +
                                   'size="2" maxlength="2"/></td>' +
                          '</tr>')
                    );
                });
            }
        }

        function loadGameInfo() {
            $.post('responder.php',
                   {type: 'loadGameData'},
                   function(rs) {
                       if (rs.status == 'ok') {
                           var gameData = rs.gameData.data;
                           gameId = gameData.gameId;
                           playerIdArray = gameData.playerIdArray;
                           currentPlayerIdx = rs.currentPlayerIdx;
                           opponentPlayerIdx = (currentPlayerIdx + 1)%2;
                           currentPlayerDieRecipeArray = gameData.dieRecipeArrayArray[currentPlayerIdx];
                           opponentPlayerDieRecipeArray = gameData.dieRecipeArrayArray[opponentPlayerIdx];
                           swingRequestArray = gameData.swingRequestArrayArray[currentPlayerIdx];
                           roundNumber = gameData.roundNumber;

                           $('#game_id').text(gameId);
                           $('#round_number').text(roundNumber);
                           $('#timestamp').text(rs.timestamp);
                           $('#header_current_player').text(rs.playerNameArray[currentPlayerIdx]);
                           $('#header_opponent').text(rs.playerNameArray[opponentPlayerIdx]);

                           displayDieDetails();
                           displaySwingDetails();
                       } else {
                           $('#game_id').html('JSON fetch failed\n'+
                                              JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                       }
                   });
        }

        $('#submit').click(function() {
            var textFieldsFilled = true;
            swingValueArray = [];

            $('input:text').each(function(index, element) {
                var value = $(element).val();
                if ($.isNumeric(value)) {
                    swingValueArray[index] = value;
                } else {
                    textFieldsFilled = false;
                }
            });

            if (textFieldsFilled) {
                $.post('responder.php',
                       {
                           type: 'submitSwingValues',
                           roundNumber: roundNumber,
                           swingValueArray: swingValueArray,
                           timestamp: $('#timestamp').text()
                       },
                       function(rs){
                           if ('ok' == rs.status) {
                               $('#submit_status').text('Successful swing value set.');
                           } else {
                               $('#submit_status').text('Failed swing value set.');
                           }
                       });
            }
        });

        // code to initialise game variables
        currentPlayerIdx = 1;

        // code to run when page is ready
        loadGameInfo();
    });

    </script>
</body>
</html>