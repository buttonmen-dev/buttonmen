<!DOCTYPE html>
<!--
    This document should be written in polyglot HTML5/XHTML5, and therefore
    should run when served either as text/html or application/xhtml+xml.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8" />
    <title>Choose swing values</title>
    <link rel="stylesheet" href="gui.css" />
</head>

<body>
    <div>Game #<span id="game_id">?</span></div>
    <div>Round #<span id="round_number">?</span></div>
    <br />

    <table id="die_description_table">
        <tr>
            <th>Your dice</th>
            <th>Opponent's dice</th>
        </tr>
        <tr>
            <td id="div_current_player"></td>
            <td id="div_opponent"></td>
        </tr>
    </table>

    <br />

    <div class="title2">
        Set your swing values
    </div>

    <div>
    <form action="responder.php" method="post">
        <table id="swing_table">
        </table>
        <br />
        <div><span id="submit_status"></span></div>
    </form>
    </div>

    <br />
    <div ><button id="submit">Submit</button></div>

    <!--
    james: eventually, we will want to use the hosted version of the JQuery library
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    -->
    <script src="jquery-1.9.0.min.js"></script>
    <script>

    $(document).ready(function() {
        // global variables
        var gameId;
        var roundNumber;
        var currentPlayerIdx;
        var opponentPlayerIdx;
        var currentPlayerDieRecipeArray;
        var opponentPlayerDieRecipeArray;
        var swingRequestArray;
        var swingValueArray;

        function displayDieDetails() {
            $.each(currentPlayerDieRecipeArray, function(index, value) {
                $('#div_current_player').append('<p>' + value + '</p>');
            })

            $.each(opponentPlayerDieRecipeArray, function(index, value) {
                $('#div_opponent').append('<p>' + value + '</p>');
            })
        }

        function displaySwingDetails() {
            if (document.createElement){
                $.each(swingRequestArray, function(index, value) {
                    $('#swing_table').append(
                        $('<tr>' +
                              '<td>' + value + ' :</td>' +
                              '<td><input type="text" class="text" ' +
                                   'id="swing_' + index +
                                   '" ' +
                                   'size="2" maxlength="2"/></td>' +
                          '</tr>')
                    );
                })
            }
        }

        function loadGameInfo() {
            $.ajax({                                   // Do a jQuery AJAX fetch
                url: 'load_test_game_waiting_on_swing.php',
                success: function(rs, status, xhr) {
                    if (rs.status == 'ok') {
                        opponentPlayerIdx = (currentPlayerIdx + 1)%2;
                        currentPlayerDieRecipeArray = rs.data.dieRecipeArrayArray[currentPlayerIdx];
                        opponentPlayerDieRecipeArray = rs.data.dieRecipeArrayArray[opponentPlayerIdx];
                        swingRequestArray = rs.data.swingRequestArrayArray[currentPlayerIdx];
                        gameId = rs.data.gameId;
                        roundNumber = rs.data.roundNumber;

                        $('#game_id').text(gameId);
                        $('#round_number').text(roundNumber);

                        displayDieDetails();
                        displaySwingDetails();
                    } else {
                        $('#game_id').html("JSON fetch failed\n"+
                                           JSON.stringify(rs.data));  // We got some JSON we didn't expect (the network fetch succeeded, but the engine had an error)
                    }
                }
            });
        }

        $('#submit').click(function() {
            var textFieldsFilled = true;
            swingValueArray = [];

            $("input:text").each(function(index, element) {
                var value = $(element).val();
                if ($.isNumeric(value)) {
                    swingValueArray[index] = value;
                } else {
                    textFieldsFilled = false;
                };
            });

            if (textFieldsFilled) {

                $.post('responder.php',
                       {
                           type: 'submitSwingValues',
                           gameId: gameId,
                           roundNumber: roundNumber,
                           currentPlayerIdx: currentPlayerIdx,
                           swingValueArray: JSON.stringify(swingValueArray)
                       },
                       function(rs){
                           $('#submit_status').html(rs.status);
                       });
            }
        });

        // code to initialise game variables
        currentPlayerIdx = 1;

        // code to run when page is ready
        loadGameInfo();
    });

    </script>
</body>
</html>